input {
  tcp {
    port => 5000
    codec => json_lines
    tags => ["honeypot"]
    host => "0.0.0.0"
  }
  udp {
    port => 5000
    codec => json_lines
    tags => ["honeypot"]
    host => "0.0.0.0"
  }
}

filter {
  # Parse timestamp
  date {
    match => [ "timestamp", "ISO8601" ] # <-- Corrected from ISO8061
    target => "@timestamp"
  }

  # Add ECS fields
  mutate {
    add_field => {
      "[event][kind]" => "alert"
      "[event][category]" => "intrusion_detection"
      "[event][type]" => "info"
    }
  }

  # Set severity based on event type
  if [event_type] == "ids_alert" {
    mutate {
      add_field => { "[event][severity]" => "3" }
    }

    if [severity] == "HIGH_RISK" {
      mutate {
        replace => { "[event][severity]" => "7" }
      }
    }
  }

  # Map source IP fields to ECS
  if [source_ip] {
    mutate {
      add_field => { "[source][ip]" => "%{source_ip}" }
    }
  }

  if [destination_ip] {
    mutate {
      add_field => { "[destination][ip]" => "%{destination_ip}" }
    }
  }

  # Map GeoIP fields to ECS
  if [geoip][city] {
    mutate {
      add_field => { "[source][geo][city_name]" => "%{[geoip][city]}" }
    }
  }

  if [geoip][country] {
    mutate {
      add_field => { "[source][geo][country_name]" => "%{[geoip][country]}" }
    }
  }

  if [geoip][country_code] {
    mutate {
      add_field => { "[source][geo][country_iso_code]" => "%{[geoip][country_code]}" }
    }
  }

  # *** THIS IS THE CORRECTED MAP FIX ***
  # Combine lat/lon into a single field for the map
  if [geoip][latitude] and [geoip][longitude] {
    mutate {
      # Create a single field in "lat,lon" string format
      add_field => { "[source][geo][location]" => "%{[geoip][latitude]},%{[geoip][longitude]}" }
    }
  }

  # Add alert type as rule name
  if [alert_type] {
    mutate {
      add_field => { "[rule][name]" => "%{alert_type}" }
    }
  }

  # Add HTTP fields if present
  if [method] {
    mutate {
      add_field => { "[http][request][method]" => "%{method}" }
    }
  }

  if [path] {
    mutate {
      add_field => { "[url][path]" => "%{path}" }
    }
  }

  if [user_agent] {
    mutate {
      add_field => { "[user_agent][original]" => "%{user_agent}" }
    }
  }

  if [response_status] {
    mutate {
      add_field => { "[http][response][status_code]" => "%{response_status}" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "honeypot-%{+YYYY.MM.dd}"
    ecs_compatibility => "v8"
  }
  # Temporarily enable for debugging
  stdout {
    codec => rubydebug
  }
}
